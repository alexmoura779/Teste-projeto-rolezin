<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Gastron√¥mico de Estabelecimentos de Gosto Duvidosos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFA500 0%, #FFB84D 50%, #FF8C00 100%);
            min-height: 100vh;
            padding: 20px;
            background-attachment: fixed;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .header-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn-add {
            background: white;
            color: #FF8C00;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-admin {
            background: #DC143C;
            color: white;
        }

        .encontros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .encontro-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .encontro-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .card-image-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-edit-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn-edit-menu:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .card-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .card-date {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 10px;
        }

        .card-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stars {
            color: #ffc107;
            font-size: 1.2em;
        }

        .rating-value {
            color: #666;
            font-weight: bold;
        }

        .card-reviews {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 15px;
        }

        .btn-avaliar {
            width: 100%;
            background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-avaliar:hover {
            opacity: 0.9;
        }

        .btn-avaliar:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-delete {
            width: 100%;
            background: #DC143C;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #FF8C00;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .star-rating {
            display: flex;
            gap: 10px;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .star-rating span {
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s ease;
        }

        .star-rating span:hover,
        .star-rating span.active {
            color: #ffc107;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit {
            background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);
            color: white;
        }

        .btn-submit:hover {
            opacity: 0.9;
        }

        .btn-cancel {
            background: #f0f0f0;
            color: #333;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .already-rated {
            background: #f0f0f0;
            color: #666;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .user-review {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #FF8C00;
        }

        .user-review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .user-review-stars {
            color: #ffc107;
            margin-bottom: 8px;
        }

        .user-review-comment {
            color: #666;
            font-size: 0.95em;
        }

        .image-input-group {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 100%;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            margin-top: 10px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .empty-state {
            text-align: center;
            color: #999;
            font-size: 0.9em;
        }

        .future-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .placeholder-image {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #ccc;
        }

        .achievement-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .achievement-content {
            background: linear-gradient(135deg, #FF8C00 0%, #FFA500 100%);
            padding: 50px 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.5s ease;
        }

        .achievement-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 0.6s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .achievement-title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .achievement-subtitle {
            font-size: 1.3em;
            margin-bottom: 20px;
            opacity: 0.95;
        }

        .achievement-message {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .achievement-button {
            background: white;
            color: #FF8C00;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .achievement-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .admin-panel {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #DC143C;
        }

        .admin-panel h3 {
            color: #DC143C;
            margin-bottom: 10px;
        }

        .admin-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-btn {
            background: #DC143C;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .edit-menu {
            position: absolute;
            top: 50px;
            right: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            min-width: 150px;
        }

        .edit-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.9em;
            color: #333;
            transition: background 0.2s ease;
        }

        .edit-menu button:hover {
            background: #f5f5f5;
        }

        .edit-menu button:first-child {
            border-radius: 8px 8px 0 0;
        }

        .edit-menu button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .edit-menu button:not(:last-child) {
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üçΩÔ∏è Guia Gastron√¥mico de Estabelecimentos de Gosto Duvidosos</h1>
            <p>Avalia√ß√£o de p√©ssimas decis√µes alimentares e rol√™s plat√¥nicos duvidosos, n√£o vai encontrar estrelas Michelin aqui, mas sim boas mem√≥rias, e sim, ao contr√°rio dos boatos por a√≠ a gente s√≥ come mesmoüòè</p>
            <div class="header-buttons">
                <button class="btn-add" onclick="abrirModalNovoEncontro()">‚úÖ Incluir rol√™ realizado</button>
                <button class="btn-add" onclick="abrirModalMarcarEncontro()">üìÖ Agendar sa√≠da</button>
            </div>
        </header>

        <div id="adminPanel"></div>

        <div class="encontros-grid" id="encontrosGrid">
            <div class="loading">Carregando dados...</div>
        </div>
    </div>

    <!-- Modal para Novo Encontro -->
    <div id="modalNovoEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalNovoEncontro')">&times;</span>
            <div class="modal-header">Novo Encontro</div>
            
            <div class="image-input-group">
                <label>Imagem do Local</label>
                <input type="file" id="novaImagemInput" accept="image/*" onchange="previewImagem('novaImagemInput', 'previewNovaImagem')">
                <div class="image-preview" id="previewNovaImagem">
                    <div class="empty-state">Selecione uma imagem</div>
                </div>
            </div>

            <div class="form-group">
                <label>Nome do Local</label>
                <input type="text" id="novoNome" placeholder="Ex: Mc'donalds (Barra Funda)">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalNovoEncontro')">Cancelar</button>
                <button class="btn-modal btn-submit" onclick="adicionarNovoEncontro()">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Marcar Encontro Futuro -->
    <div id="modalMarcarEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalMarcarEncontro')">&times;</span>
            <div class="modal-header">Agendar Sa√≠da Futura</div>
            
            <div class="image-input-group">
                <label>Imagem do Local (opcional)</label>
                <input type="file" id="marcarImagemInput" accept="image/*" onchange="previewImagem('marcarImagemInput', 'previewMarcarImagem')">
                <div class="image-preview" id="previewMarcarImagem">
                    <div class="empty-state">Selecione uma imagem</div>
                </div>
            </div>

            <div class="form-group">
                <label>Nome do Local</label>
                <input type="text" id="marcarNome" placeholder="Ex: Restaurante XYZ">
            </div>

            <div class="form-group">
                <label>Data Sugerida</label>
                <input type="date" id="marcarData">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalMarcarEncontro')">Cancelar</button>
                <button class="btn-modal btn-submit" onclick="marcarNovoEncontro()">Agendar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Avaliar -->
    <div id="modalAvaliar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalAvaliar')">&times;</span>
            <div class="modal-header" id="avaliarTitulo">Avaliar Encontro</div>
            
            <div class="form-group">
                <label>Sua Nota (0-5 estrelas)</label>
                <div class="star-rating" id="starRating">
                    <span onclick="selecionarEstrela(1)">‚òÖ</span>
                    <span onclick="selecionarEstrela(2)">‚òÖ</span>
                    <span onclick="selecionarEstrela(3)">‚òÖ</span>
                    <span onclick="selecionarEstrela(4)">‚òÖ</span>
                    <span onclick="selecionarEstrela(5)">‚òÖ</span>
                </div>
            </div>

            <div class="form-group">
                <label>Coment√°rio (opcional)</label>
                <textarea id="comentario" placeholder="Compartilhe sua opini√£o sobre o local..."></textarea>
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalAvaliar')">Cancelar</button>
                <button class="btn-modal btn-submit" onclick="enviarAvaliacao()">Enviar Avalia√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Nome e Imagem -->
    <div id="modalEditarEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalEditarEncontro')">&times;</span>
            <div class="modal-header">Editar Encontro</div>
            
            <div class="image-input-group">
                <label>Imagem do Local</label>
                <input type="file" id="editarImagemInput" accept="image/*" onchange="previewImagem('editarImagemInput', 'previewEditarImagem')">
                <div class="image-preview" id="previewEditarImagem">
                    <div class="empty-state">Selecione uma imagem</div>
                </div>
            </div>

            <div class="form-group">
                <label>Nome do Local</label>
                <input type="text" id="editarNomeInput" placeholder="Digite o novo nome">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="fecharModal('modalEditarEncontro')">Cancelar</button>
                <button class="btn-modal btn-submit" onclick="salvarEdicaoEncontro()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Achievement -->
    <div id="achievementModal" class="achievement-modal">
        <div class="achievement-content">
            <div class="achievement-icon" id="achievementIcon">üèÜ</div>
            <div class="achievement-title" id="achievementTitle">Parab√©ns!</div>
            <div class="achievement-subtitle" id="achievementSubtitle">Agora voc√™s s√£o: Conversantes</div>
            <div class="achievement-message" id="achievementMessage"></div>
            <button class="achievement-button" onclick="fecharAchievement()">Continuar</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

 <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBDsI99-q_lIguxeta6erbnoFuMcSv-qBw",
    authDomain: "projeto-1-717f0.firebaseapp.com",
    projectId: "projeto-1-717f0",
    storageBucket: "projeto-1-717f0.firebasestorage.app",
    messagingSenderId: "313396412559",
    appId: "1:313396412559:web:1c25f76e6a867997f3f0fa",
    measurementId: "G-XSKY77GZ91"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

        // ============================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================
        let encontros = [];
        let encontroAtualId = null;
        let estrelasSelecionadas = 0;
        let encontroEditando = null;
        let usuarioAtual = null;
        let isAdmin = false;
        let unsubscribe = null;

        const encontrosExemplo = [
            {
                nome: "Mc'donalds (Barra Funda)",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Pastelaria da Ex noiva",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Pastelaria do bebum perdido",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Marmita de pagamento em 90 dias",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Conveni√™ncia Barra Funda (picol√© pre√ßo de 2 leva 1)",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            }
        ];

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        async function inicializar() {
            obterUsuarioAtual();
            isAdmin = usuarioAtual === 'alex';
            
            // Verificar se √© a primeira vez
            const docRef = db.collection('config').doc('geral');
            const docSnap = await docRef.get();
            
            if (!docSnap.exists()) {
                // Primeira vez - criar dados de exemplo
                await inicializarDadosExemplo();
            }
            
            // Configurar listener para sincroniza√ß√£o em tempo real
            configurarListenerEncontros();
            atualizarPainelAdmin();
        }

        async function inicializarDadosExemplo() {
            try {
                for (const encontro of encontrosExemplo) {
                    await db.collection('encontros').add({
                        ...encontro,
                        criadoEm: new Date()
                    });
                }
                await db.collection('config').doc('geral').set({
                    inicializado: true
                });
            } catch (error) {
                console.error('Erro ao inicializar dados:', error);
            }
        }

        function configurarListenerEncontros() {
            // Se j√° existe um listener, remover
            if (unsubscribe) {
                unsubscribe();
            }

            // Configurar novo listener - SINCRONIZA√á√ÉO EM TEMPO REAL
            unsubscribe = db.collection('encontros')
                .orderBy('criadoEm', 'desc')
                .onSnapshot((snapshot) => {
                    encontros = [];
                    snapshot.forEach((doc) => {
                        encontros.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderizarEncontros();
                }, (error) => {
                    console.error('Erro ao carregar encontros:', error);
                });
        }

        function obterUsuarioAtual() {
            let usuario = sessionStorage.getItem('usuarioAtual');
            if (!usuario) {
                const nome = prompt('Qual √© o seu nome?');
                if (nome) {
                    usuario = nome.toLowerCase().trim();
                    sessionStorage.setItem('usuarioAtual', usuario);
                } else {
                    usuario = 'usuario_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('usuarioAtual', usuario);
                }
            }
            usuarioAtual = usuario;
            return usuario;
        }

        // ============================================
        // RENDERIZA√á√ÉO
        // ============================================
        function renderizarEncontros() {
            const grid = document.getElementById('encontrosGrid');
            grid.innerHTML = '';

            if (encontros.length === 0) {
                grid.innerHTML = '<div class="loading">Nenhum encontro ainda. Crie um novo!</div>';
                return;
            }

            encontros.forEach(encontro => {
                const mediaNotas = encontro.avaliacoes.length > 0
                    ? (encontro.avaliacoes.reduce((sum, a) => sum + a.nota, 0) / encontro.avaliacoes.length).toFixed(1)
                    : 0;

                const estrelas = '‚òÖ'.repeat(Math.round(mediaNotas)) + '‚òÜ'.repeat(5 - Math.round(mediaNotas));
                const usuarioJaAvaliou = encontro.avaliacoes.some(a => a.usuario === usuarioAtual);

                const card = document.createElement('div');
                card.className = 'encontro-card';
                card.innerHTML = `
                    <div class="card-image-container">
                        ${encontro.imagem ? 
                            `<img src="${encontro.imagem}" alt="${encontro.nome}" class="card-image">` : 
                            `<div class="placeholder-image">üì∏</div>`
                        }
                        <button class="btn-edit-menu" onclick="abrirMenuEdicao(event, '${encontro.id}')">‚öôÔ∏è</button>
                    </div>
                    <div class="card-content">
                        <div class="card-title">
                            <div style="flex: 1;">
                                ${encontro.nome}
                                ${encontro.isFuturo && !dataPassou(encontro.data) ? '<span class="future-badge">FUTURO</span>' : ''}
                            </div>
                        </div>
                        ${encontro.data ? `<div class="card-date">üìÖ ${formatarData(encontro.data)}</div>` : ''}
                        <div class="card-rating">
                            <span class="stars">${estrelas}</span>
                            <span class="rating-value">${mediaNotas}/5</span>
                        </div>
                        <div class="card-reviews">${encontro.avaliacoes.length} avalia√ß√µes</div>
                        
                        ${encontro.avaliacoes.length > 0 ? `
                            <div style="margin-bottom: 15px; max-height: 150px; overflow-y: auto;">
                                ${encontro.avaliacoes.map(a => `
                                    <div class="user-review">
                                        <div class="user-review-header">
                                            <span>${a.usuario}</span>
                                            <span class="user-review-stars">${'‚òÖ'.repeat(a.nota)}${'‚òÜ'.repeat(5-a.nota)}</span>
                                        </div>
                                        ${a.comentario ? `<div class="user-review-comment">"${a.comentario}"</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${usuarioJaAvaliou ? `
                            <div class="already-rated">‚úì Voc√™ j√° avaliou este local</div>
                        ` : `
                            <button class="btn-avaliar" onclick="abrirModalAvaliar('${encontro.id}')">Avaliar</button>
                        `}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function atualizarPainelAdmin() {
            const panel = document.getElementById('adminPanel');
            
            if (isAdmin) {
                const encontrosMarcados = encontros.filter(e => e.isFuturo && !dataPassou(e.data)).length;
                panel.innerHTML = `
                    <div class="admin-panel">
                        <h3>üîê Painel de Administrador (${usuarioAtual})</h3>
                        <p>Encontros marcados: ${encontrosMarcados}</p>
                        <div class="admin-buttons">
                            <button class="admin-btn" onclick="resetarEncontrosMarcados()">Resetar Encontros Marcados</button>
                            <button class="admin-btn" onclick="resetarTudo()">Resetar Tudo</button>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = '';
            }
        }

        // ============================================
        // MODAIS
        // ============================================
        function abrirModalNovoEncontro() {
            document.getElementById('modalNovoEncontro').style.display = 'block';
        }

        function abrirModalMarcarEncontro() {
            document.getElementById('modalMarcarEncontro').style.display = 'block';
            document.getElementById('marcarData').valueAsDate = new Date();
        }

        function abrirModalAvaliar(id) {
            encontroAtualId = id;
            const encontro = encontros.find(e => e.id === id);
            document.getElementById('avaliarTitulo').textContent = `Avaliar: ${encontro.nome}`;
            document.getElementById('modalAvaliar').style.display = 'block';
            estrelasSelecionadas = 0;
            atualizarEstrelas();
            document.getElementById('comentario').value = '';
        }

        function abrirMenuEdicao(event, id) {
            event.stopPropagation();
            
            // Remover menu anterior se existir
            const menuAnterior = document.querySelector('.edit-menu');
            if (menuAnterior) {
                menuAnterior.remove();
            }

            const encontro = encontros.find(e => e.id === id);
            const menu = document.createElement('div');
            menu.className = 'edit-menu';
            menu.innerHTML = `
                <button onclick="abrirModalEditarEncontro('${id}')">‚úèÔ∏è Editar Nome/Foto</button>
                ${isAdmin ? `<button onclick="excluirEncontro('${id}')">üóëÔ∏è Excluir</button>` : ''}
            `;
            
            event.target.parentElement.appendChild(menu);
            
            // Fechar menu ao clicar fora
            document.addEventListener('click', function fecharMenu(e) {
                if (!menu.contains(e.target) && !e.target.classList.contains('btn-edit-menu')) {
                    menu.remove();
                    document.removeEventListener('click', fecharMenu);
                }
            });
        }

        function abrirModalEditarEncontro(id) {
            encontroEditando = id;
            const encontro = encontros.find(e => e.id === id);
            document.getElementById('editarNomeInput').value = encontro.nome;
            document.getElementById('modalEditarEncontro').style.display = 'block';
            document.getElementById('editarImagemInput').value = '';
            document.getElementById('previewEditarImagem').innerHTML = encontro.imagem 
                ? `<img src="${encontro.imagem}" alt="Preview">` 
                : '<div class="empty-state">Selecione uma imagem</div>';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ============================================
        // AVALIA√á√ïES
        // ============================================
        function selecionarEstrela(numero) {
            estrelasSelecionadas = numero;
            atualizarEstrelas();
        }

        function atualizarEstrelas() {
            const stars = document.querySelectorAll('#starRating span');
            stars.forEach((star, index) => {
                if (index < estrelasSelecionadas) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function enviarAvaliacao() {
            if (estrelasSelecionadas === 0) {
                alert('Por favor, selecione uma nota!');
                return;
            }

            const encontro = encontros.find(e => e.id === encontroAtualId);
            
            if (encontro.avaliacoes.some(a => a.usuario === usuarioAtual)) {
                alert('Voc√™ j√° avaliou este local!');
                return;
            }

            try {
                const novaAvaliacao = {
                    usuario: usuarioAtual,
                    nota: estrelasSelecionadas,
                    comentario: document.getElementById('comentario').value
                };

                const avaliacoesAtualizadas = [...encontro.avaliacoes, novaAvaliacao];

                await db.collection('encontros').doc(encontroAtualId).update({
                    avaliacoes: avaliacoesAtualizadas
                });

                fecharModal('modalAvaliar');
                alert('Avalia√ß√£o enviada com sucesso!');
            } catch (error) {
                console.error('Erro ao enviar avalia√ß√£o:', error);
                alert('Erro ao enviar avalia√ß√£o');
            }
        }

        // ============================================
        // ADICIONAR/MARCAR ENCONTROS
        // ============================================
        async function adicionarNovoEncontro() {
            const nome = document.getElementById('novoNome').value.trim();
            const imagemInput = document.getElementById('novaImagemInput');

            if (!nome) {
                alert('Por favor, insira o nome do local!');
                return;
            }

            try {
                let imagem = null;
                if (imagemInput.files.length > 0) {
                    imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').add({
                    nome: nome,
                    imagem: imagem,
                    avaliacoes: [],
                    data: null,
                    isFuturo: false,
                    criadoEm: new Date()
                });

                fecharModal('modalNovoEncontro');
                document.getElementById('novoNome').value = '';
                imagemInput.value = '';
                document.getElementById('previewNovaImagem').innerHTML = '<div class="empty-state">Selecione uma imagem</div>';
                alert('Encontro adicionado com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar encontro:', error);
                alert('Erro ao adicionar encontro');
            }
        }

        async function marcarNovoEncontro() {
            const nome = document.getElementById('marcarNome').value.trim();
            const data = document.getElementById('marcarData').value;
            const imagemInput = document.getElementById('marcarImagemInput');

            if (!nome) {
                alert('Por favor, insira o nome do local!');
                return;
            }

            if (!data) {
                alert('Por favor, selecione uma data!');
                return;
            }

            try {
                let imagem = null;
                if (imagemInput.files.length > 0) {
                    imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').add({
                    nome: nome,
                    imagem: imagem,
                    avaliacoes: [],
                    data: data,
                    isFuturo: true,
                    criadoEm: new Date()
                });

                // Verificar achievement
                verificarAchievement();

                fecharModal('modalMarcarEncontro');
                document.getElementById('marcarNome').value = '';
                document.getElementById('marcarData').value = '';
                imagemInput.value = '';
                document.getElementById('previewMarcarImagem').innerHTML = '<div class="empty-state">Selecione uma imagem</div>';
                alert('Encontro agendado com sucesso!');
            } catch (error) {
                console.error('Erro ao marcar encontro:', error);
                alert('Erro ao marcar encontro');
            }
        }

        // ============================================
        // EDITAR ENCONTRO
        // ============================================
        async function salvarEdicaoEncontro() {
            const novoNome = document.getElementById('editarNomeInput').value.trim();
            const imagemInput = document.getElementById('editarImagemInput');
            const encontro = encontros.find(e => e.id === encontroEditando);

            if (!novoNome) {
                alert('Por favor, insira um nome v√°lido!');
                return;
            }

            try {
                const atualizacoes = {
                    nome: novoNome
                };

                if (imagemInput.files.length > 0) {
                    atualizacoes.imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').doc(encontroEditando).update(atualizacoes);

                fecharModal('modalEditarEncontro');
                alert('Encontro atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar encontro:', error);
                alert('Erro ao atualizar encontro');
            }
        }

        // ============================================
        // EXCLUIR ENCONTRO (APENAS ADMIN)
        // ============================================
        async function excluirEncontro(id) {
            if (!isAdmin) {
                alert('Apenas administradores podem excluir encontros!');
                return;
            }

            if (confirm('Tem certeza que deseja excluir este encontro?')) {
                try {
                    await db.collection('encontros').doc(id).delete();
                    alert('Encontro exclu√≠do com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir encontro:', error);
                    alert('Erro ao excluir encontro');
                }
            }
        }

        // ============================================
        // ACHIEVEMENTS
        // ============================================
        function verificarAchievement() {
            const encontrosMarcados = encontros.filter(e => e.isFuturo && !dataPassou(e.data)).length;
            
            // Mostrar achievement apenas quando atingir m√∫ltiplos de 3
            if (encontrosMarcados % 3 === 0 && encontrosMarcados > 0) {
                const ciclo = encontrosMarcados / 3;
                mostrarAchievement(ciclo, encontrosMarcados);
            }
        }

        function mostrarAchievement(ciclo, totalEncontros) {
            let achievement;
            let mensagem;
            
            if (ciclo === 1) {
                achievement = { titulo: "Conversante", emoji: "üí¨" };
                mensagem = `Algu√©m marcou ${totalEncontros} encontros! Isso √© mais que amizade!`;
            } else if (ciclo === 2) {
                achievement = { titulo: "Ficantes de Trabalho", emoji: "üíº" };
                mensagem = `${totalEncontros} encontros marcados? Voc√™s n√£o conseguem ficar um dia sem se ver!`;
            } else {
                achievement = { titulo: "Ficantes de Trabalho", emoji: "üíº" };
                if (ciclo % 2 === 0) {
                    mensagem = `${totalEncontros} encontros marcados? Voc√™s n√£o conseguem ficar um dia sem se ver!`;
                } else {
                    mensagem = `Algu√©m marcou ${totalEncontros} encontros! Isso √© mais que amizade!`;
                }
            }
            
            document.getElementById('achievementIcon').textContent = achievement.emoji;
            document.getElementById('achievementTitle').textContent = `Parab√©ns, ${usuarioAtual}!`;
            document.getElementById('achievementSubtitle').textContent = `Agora voc√™s s√£o: ${achievement.titulo}`;
            document.getElementById('achievementMessage').textContent = mensagem;
            
            document.getElementById('achievementModal').style.display = 'flex';
        }

        function fecharAchievement() {
            document.getElementById('achievementModal').style.display = 'none';
        }

        // ============================================
        // ADMIN - RESET
        // ============================================
        async function resetarEncontrosMarcados() {
            if (!isAdmin) {
                alert('Apenas administradores podem fazer isso!');
                return;
            }

            if (confirm('Deseja resetar apenas os encontros marcados?')) {
                try {
                    const batch = db.batch();
                    encontros.forEach(e => {
                        if (e.isFuturo) {
                            batch.update(db.collection('encontros').doc(e.id), {
                                isFuturo: false
                            });
                        }
                    });
                    await batch.commit();
                    alert('Encontros marcados resetados!');
                } catch (error) {
                    console.error('Erro ao resetar encontros marcados:', error);
                    alert('Erro ao resetar encontros marcados');
                }
            }
        }

        async function resetarTudo() {
            if (!isAdmin) {
                alert('Apenas administradores podem fazer isso!');
                return;
            }

            if (confirm('Tem certeza que deseja resetar TUDO? Essa a√ß√£o n√£o pode ser desfeita!')) {
                try {
                    // Deletar todos os encontros
                    const batch = db.batch();
                    encontros.forEach(e => {
                        batch.delete(db.collection('encontros').doc(e.id));
                    });
                    await batch.commit();

                    // Reinicializar com dados de exemplo
                    await inicializarDadosExemplo();
                    alert('Tudo foi resetado!');
                } catch (error) {
                    console.error('Erro ao resetar tudo:', error);
                    alert('Erro ao resetar tudo');
                }
            }
        }

        // ============================================
        // UTILIT√ÅRIOS
        // ============================================
        function formatarData(dataString) {
            if (!dataString) return '';
            const data = new Date(dataString + 'T00:00:00');
            return data.toLocaleDateString('pt-BR');
        }

        function dataPassou(dataString) {
            if (!dataString) return false;
            const data = new Date(dataString + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            return data < hoje;
        }

        function previewImagem(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function lerArquivoComoBase64(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(arquivo);
            });
        }

        window.onclick = function(event) {
            const modals = ['modalNovoEncontro', 'modalMarcarEncontro', 'modalAvaliar', 'modalEditarEncontro'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            const achievementModal = document.getElementById('achievementModal');
            if (event.target === achievementModal) {
                achievementModal.style.display = 'none';
            }
        }

        window.addEventListener('load', inicializar);
    </script>
</body>
</html>
