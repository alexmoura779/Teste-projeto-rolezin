<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia Gastronômico de Estabelecimentos de Gosto Duvidosos</title>
    <style>
        /* Estilos CSS (Mantidos do código original) */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #ff8c00; /* Laranja */
            color: #333;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #fff;
            font-size: 2.5em;
            margin-top: 50px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        p {
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 40px;
        }
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        .btn {
            background-color: #fff;
            color: #ff8c00;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .btn:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        .encontros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        .encontro-card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            text-align: left;
            transition: transform 0.3s;
            position: relative;
        }
        .encontro-card:hover {
            transform: translateY(-5px);
        }
        .card-image-container {
            height: 200px;
            background-color: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .placeholder-image {
            font-size: 4em;
            color: #666;
        }
        .card-content {
            padding: 20px;
        }
        .card-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff8c00;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-date {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        .card-rating {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stars {
            color: gold;
            font-size: 1.5em;
        }
        .rating-value {
            font-weight: bold;
            color: #ff8c00;
        }
        .card-reviews {
            font-size: 0.9em;
            color: #999;
            margin-bottom: 15px;
        }
        .btn-avaliar {
            background-color: #ff8c00;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-avaliar:hover {
            background-color: #e07b00;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h2 {
            color: #ff8c00;
            margin-top: 0;
        }
        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0 20px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content button {
            background-color: #ff8c00;
            color: white;
            padding: 14px 20px;
            margin: 8px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
        }
        .modal-content button:hover {
            background-color: #e07b00;
        }
        .star-rating {
            font-size: 2em;
            cursor: pointer;
            color: #ccc;
            margin-bottom: 20px;
        }
        .star-rating span.active {
            color: gold;
        }
        .star-rating span {
            transition: color 0.1s;
        }
        .already-rated {
            background-color: #e6ffe6;
            color: #008000;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .loading {
            color: #fff;
            font-size: 1.2em;
            margin-top: 50px;
        }
        .future-badge {
            background-color: #4682b4;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
            vertical-align: middle;
        }
        .admin-panel {
            background-color: #333;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .admin-panel h3 {
            margin-top: 0;
            color: #ff8c00;
        }
        .admin-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        .admin-btn {
            background-color: #ff8c00;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .admin-btn:hover {
            background-color: #e07b00;
        }
        .user-review {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .user-review:last-child {
            border-bottom: none;
        }
        .user-review-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 0.9em;
        }
        .user-review-stars {
            color: gold;
        }
        .user-review-comment {
            font-style: italic;
            color: #555;
            margin-top: 5px;
            font-size: 0.9em;
        }
        .btn-edit-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }
        .edit-menu {
            position: absolute;
            top: 40px;
            right: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 20;
            display: flex;
            flex-direction: column;
            width: 200px;
            overflow: hidden;
        }
        .edit-menu button {
            background: none;
            border: none;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9em;
            color: #333;
        }
        .edit-menu button:hover {
            background-color: #f0f0f0;
        }
        .empty-state {
            color: #999;
            text-align: center;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Achievement Modal */
        #achievementModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #ff8c00;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        .achievement-content {
            background-color: #ff8c00;
            padding: 40px;
            border-radius: 10px;
            color: #fff;
            max-width: 90%;
        }
        #achievementIcon {
            font-size: 6em;
            margin-bottom: 20px;
            display: block;
        }
        #achievementTitle {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        #achievementSubtitle {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        #achievementMessage {
            font-size: 1.2em;
            margin-bottom: 40px;
            font-style: italic;
        }
        #achievementModal button {
            background-color: #fff;
            color: #ff8c00;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="adminPanel">
            <!-- Painel Admin será inserido aqui -->
        </div>

        <h1>Guia Gastronômico de Estabelecimentos de Gosto Duvidosos</h1>
        <p>Avaliação de péssimas decisões alimentares e rolês platônicos duvidosos, não vai encontrar estrelas Michelin aqui, mas sim boas memórias, e sim, ao contrário dos boatos por aí a gente só come mesmo 😉</p>

        <div class="buttons-container">
            <button class="btn" onclick="abrirModalNovoEncontro()">
                <span style="font-size: 1.5em;">✅</span> Incluir rolê realizado
            </button>
            <button class="btn" onclick="abrirModalMarcarEncontro()">
                <span style="font-size: 1.5em;">📅</span> Agendar saída
            </button>
        </div>

        <div id="encontrosGrid" class="encontros-grid">
            <div class="loading">Carregando dados...</div>
        </div>
    </div>

    <!-- Modal Novo Encontro -->
    <div id="modalNovoEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalNovoEncontro')">&times;</span>
            <h2>Incluir Novo Rolê</h2>
            <input type="text" id="novoNome" placeholder="Nome do Local/Rolê">
            <label for="novaImagemInput" style="display: block; margin-bottom: 10px;">Adicionar Foto (opcional):</label>
            <input type="file" id="novaImagemInput" accept="image/*" onchange="previewImagem('novaImagemInput', 'previewNovaImagem')">
            <div id="previewNovaImagem" class="empty-state">Selecione uma imagem</div>
            <button onclick="adicionarNovoEncontro()">Adicionar</button>
        </div>
    </div>

    <!-- Modal Marcar Encontro -->
    <div id="modalMarcarEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalMarcarEncontro')">&times;</span>
            <h2>Agendar Saída</h2>
            <input type="text" id="marcarNome" placeholder="Nome do Local/Rolê">
            <label for="marcarData" style="display: block; margin-bottom: 10px;">Data do Encontro:</label>
            <input type="date" id="marcarData">
            <label for="marcarImagemInput" style="display: block; margin-bottom: 10px;">Adicionar Foto (opcional):</label>
            <input type="file" id="marcarImagemInput" accept="image/*" onchange="previewImagem('marcarImagemInput', 'previewMarcarImagem')">
            <div id="previewMarcarImagem" class="empty-state">Selecione uma imagem</div>
            <button onclick="marcarNovoEncontro()">Agendar</button>
        </div>
    </div>

    <!-- Modal Avaliar -->
    <div id="modalAvaliar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalAvaliar')">&times;</span>
            <h2 id="avaliarTitulo">Avaliar: [Nome do Local]</h2>
            <p>Sua nota:</p>
            <div id="starRating" class="star-rating">
                <span onclick="selecionarEstrela(1)">★</span>
                <span onclick="selecionarEstrela(2)">★</span>
                <span onclick="selecionarEstrela(3)">★</span>
                <span onclick="selecionarEstrela(4)">★</span>
                <span onclick="selecionarEstrela(5)">★</span>
            </div>
            <textarea id="comentario" placeholder="Comentário (opcional)"></textarea>
            <button onclick="enviarAvaliacao()">Enviar Avaliação</button>
        </div>
    </div>

    <!-- Modal Editar Encontro (Unificado) -->
    <div id="modalEditarEncontro" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalEditarEncontro')">&times;</span>
            <h2>Editar Encontro</h2>
            <label for="editarNomeInput" style="display: block; margin-bottom: 10px;">Novo Nome:</label>
            <input type="text" id="editarNomeInput" placeholder="Nome do Local/Rolê">
            <label for="editarImagemInput" style="display: block; margin-bottom: 10px;">Nova Foto (substituir):</label>
            <input type="file" id="editarImagemInput" accept="image/*" onchange="previewImagem('editarImagemInput', 'previewEditarImagem')">
            <div id="previewEditarImagem" class="empty-state">Selecione uma imagem</div>
            <button onclick="salvarEdicaoEncontro()">Salvar Alterações</button>
        </div>
    </div>

    <!-- Achievement Modal -->
    <div id="achievementModal" class="modal">
        <div class="achievement-content">
            <span id="achievementIcon">🏆</span>
            <div id="achievementTitle">PARABÉNS!</div>
            <div id="achievementSubtitle">Agora vocês são: Conversantes</div>
            <div id="achievementMessage">Mensagem aqui</div>
            <button onclick="fecharAchievement()">Continuar</button>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE (CORREÇÃO FINAL)
        // ============================================
        // INSTRUÇÕES: Substitua os valores abaixo pelas suas credenciais do Firebase
        // 1. Acesse https://console.firebase.google.com
        // 2. Crie um novo projeto
        // 3. Ative o Firestore Database (modo teste)
        // 4. Vá em "Configurações do Projeto" > "Aplicativos" > "Web"
        // 5. Copie as credenciais e substitua abaixo

        const firebaseConfig = {
            apiKey: "SUBSTITUA_AQUI", // Cole aqui
            authDomain: "SUBSTITUA_AQUI", // Cole aqui
            projectId: "SUBSTITUA_AQUI", // Cole aqui
            storageBucket: "SUBSTITUA_AQUI", // Cole aqui
            messagingSenderId: "SUBSTITUA_AQUI", // Cole aqui
            appId: "SUBSTITUA_AQUI" // Cole aqui
        };

        // ============================================
        // VARIÁVEIS GLOBAIS
        // ============================================
        let encontros = [];
        let encontroAtualId = null;
        let estrelasSelecionadas = 0;
        let encontroEditando = null;
        let usuarioAtual = null;
        let isAdmin = false;
        let unsubscribe = null;
        let db = null; // Declarado aqui

        const encontrosExemplo = [
            {
                nome: "Mc'donalds (Barra Funda)",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Pastelaria da Ex noiva",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Pastelaria do bebum perdido",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Marmita de pagamento em 90 dias",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            },
            {
                nome: "Conveniência Barra Funda (picolé preço de 2 leva 1)",
                imagem: null,
                avaliacoes: [],
                data: null,
                isFuturo: false
            }
        ];

        // ============================================
        // INICIALIZAÇÃO
        // ============================================
        async function inicializar() {
            // CORREÇÃO FINAL: Inicialização do Firebase aqui, garantindo que as bibliotecas
            // já foram carregadas e o 'firebase' está definido.
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            obterUsuarioAtual();
            isAdmin = usuarioAtual === 'alex';
            
            // Verificar se é a primeira vez
            const docRef = db.collection('config').doc('geral');
            const docSnap = await docRef.get();
            
            if (!docSnap.exists()) {
                // Primeira vez - criar dados de exemplo
                await inicializarDadosExemplo();
            }
            
            // Configurar listener para sincronização em tempo real
            configurarListenerEncontros();
            atualizarPainelAdmin();
        }

        async function inicializarDadosExemplo() {
            try {
                for (const encontro of encontrosExemplo) {
                    await db.collection('encontros').add({
                        ...encontro,
                        criadoEm: new Date()
                    });
                }
                await db.collection('config').doc('geral').set({
                    inicializado: true
                });
            } catch (error) {
                console.error('Erro ao inicializar dados:', error);
            }
        }

        function configurarListenerEncontros() {
            // Se já existe um listener, remover
            if (unsubscribe) {
                unsubscribe();
            }

            // Configurar novo listener - SINCRONIZAÇÃO EM TEMPO REAL
            unsubscribe = db.collection('encontros')
                .orderBy('criadoEm', 'desc')
                .onSnapshot((snapshot) => {
                    encontros = [];
                    snapshot.forEach((doc) => {
                        encontros.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderizarEncontros();
                }, (error) => {
                    console.error('Erro ao carregar encontros:', error);
                });
        }

        function obterUsuarioAtual() {
            let usuario = sessionStorage.getItem('usuarioAtual');
            if (!usuario) {
                const nome = prompt('Qual é o seu nome?');
                if (nome) {
                    usuario = nome.toLowerCase().trim();
                    sessionStorage.setItem('usuarioAtual', usuario);
                } else {
                    usuario = 'usuario_' + Math.random().toString(36).substr(2, 9);
                    sessionStorage.setItem('usuarioAtual', usuario);
                }
            }
            usuarioAtual = usuario;
            return usuario;
        }

        // ============================================
        // RENDERIZAÇÃO
        // ============================================
        function renderizarEncontros() {
            const grid = document.getElementById('encontrosGrid');
            grid.innerHTML = '';

            if (encontros.length === 0) {
                grid.innerHTML = '<div class="loading">Nenhum encontro ainda. Crie um novo!</div>';
                return;
            }

            encontros.forEach(encontro => {
                const mediaNotas = encontro.avaliacoes.length > 0
                    ? (encontro.avaliacoes.reduce((sum, a) => sum + a.nota, 0) / encontro.avaliacoes.length).toFixed(1)
                    : 0;

                const estrelas = '★'.repeat(Math.round(mediaNotas)) + '☆'.repeat(5 - Math.round(mediaNotas));
                const usuarioJaAvaliou = encontro.avaliacoes.some(a => a.usuario === usuarioAtual);

                const card = document.createElement('div');
                card.className = 'encontro-card';
                card.innerHTML = `
                    <div class="card-image-container">
                        ${encontro.imagem ? 
                            `<img src="${encontro.imagem}" alt="${encontro.nome}" class="card-image">` : 
                            `<div class="placeholder-image">📸</div>`
                        }
                        <button class="btn-edit-menu" onclick="abrirMenuEdicao(event, '${encontro.id}')">⚙️</button>
                    </div>
                    <div class="card-content">
                        <div class="card-title">
                            <div style="flex: 1;">
                                ${encontro.nome}
                                ${encontro.isFuturo && !dataPassou(encontro.data) ? '<span class="future-badge">FUTURO</span>' : ''}
                            </div>
                        </div>
                        ${encontro.data ? `<div class="card-date">📅 ${formatarData(encontro.data)}</div>` : ''}
                        <div class="card-rating">
                            <span class="stars">${estrelas}</span>
                            <span class="rating-value">${mediaNotas}/5</span>
                        </div>
                        <div class="card-reviews">${encontro.avaliacoes.length} avaliações</div>
                        
                        ${encontro.avaliacoes.length > 0 ? `
                            <div style="margin-bottom: 15px; max-height: 150px; overflow-y: auto;">
                                ${encontro.avaliacoes.map(a => `
                                    <div class="user-review">
                                        <div class="user-review-header">
                                            <span>${a.usuario}</span>
                                            <span class="user-review-stars">${'★'.repeat(a.nota)}${'☆'.repeat(5-a.nota)}</span>
                                        </div>
                                        ${a.comentario ? `<div class="user-review-comment">"${a.comentario}"</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        ${usuarioJaAvaliou ? `
                            <div class="already-rated">✓ Você já avaliou este local</div>
                        ` : `
                            <button class="btn-avaliar" onclick="abrirModalAvaliar('${encontro.id}')">Avaliar</button>
                        `}
                    </div>
                `;
                grid.appendChild(card);
            });
            
            // Verificar achievement após renderizar
            verificarAchievement();
        }

        function atualizarPainelAdmin() {
            const panel = document.getElementById('adminPanel');
            
            if (isAdmin) {
                const encontrosMarcados = encontros.filter(e => e.isFuturo && !dataPassou(e.data)).length;
                panel.innerHTML = `
                    <div class="admin-panel">
                        <h3>🔐 Painel de Administrador (${usuarioAtual})</h3>
                        <p>Encontros marcados: ${encontrosMarcados}</p>
                        <div class="admin-buttons">
                            <button class="admin-btn" onclick="resetarEncontrosMarcados()">Resetar Encontros Marcados</button>
                            <button class="admin-btn" onclick="resetarTudo()">Resetar Tudo</button>
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = '';
            }
        }

        // ============================================
        // MODAIS
        // ============================================
        function abrirModalNovoEncontro() {
            document.getElementById('modalNovoEncontro').style.display = 'block';
        }

        function abrirModalMarcarEncontro() {
            document.getElementById('modalMarcarEncontro').style.display = 'block';
            document.getElementById('marcarData').valueAsDate = new Date();
        }

        function abrirModalAvaliar(id) {
            encontroAtualId = id;
            const encontro = encontros.find(e => e.id === id);
            document.getElementById('avaliarTitulo').textContent = `Avaliar: ${encontro.nome}`;
            document.getElementById('modalAvaliar').style.display = 'block';
            estrelasSelecionadas = 0;
            atualizarEstrelas();
            document.getElementById('comentario').value = '';
        }

        function abrirMenuEdicao(event, id) {
            event.stopPropagation();
            
            // Remover menu anterior se existir
            const menuAnterior = document.querySelector('.edit-menu');
            if (menuAnterior) {
                menuAnterior.remove();
            }

            const encontro = encontros.find(e => e.id === id);
            const menu = document.createElement('div');
            menu.className = 'edit-menu';
            menu.innerHTML = `
                <button onclick="abrirModalEditarEncontro('${id}')">✏️ Editar Nome/Foto</button>
                ${isAdmin ? `<button onclick="excluirEncontro('${id}')">🗑️ Excluir</button>` : ''}
            `;
            
            event.target.parentElement.appendChild(menu);
            
            // Fechar menu ao clicar fora
            document.addEventListener('click', function fecharMenu(e) {
                if (!menu.contains(e.target) && !e.target.classList.contains('btn-edit-menu')) {
                    menu.remove();
                    document.removeEventListener('click', fecharMenu);
                }
            });
        }

        function abrirModalEditarEncontro(id) {
            encontroEditando = id;
            const encontro = encontros.find(e => e.id === id);
            document.getElementById('editarNomeInput').value = encontro.nome;
            document.getElementById('modalEditarEncontro').style.display = 'block';
            document.getElementById('editarImagemInput').value = '';
            document.getElementById('previewEditarImagem').innerHTML = encontro.imagem 
                ? `<img src="${encontro.imagem}" alt="Preview">` 
                : '<div class="empty-state">Selecione uma imagem</div>';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ============================================
        // AVALIAÇÕES
        // ============================================
        function selecionarEstrela(numero) {
            estrelasSelecionadas = numero;
            atualizarEstrelas();
        }

        function atualizarEstrelas() {
            const stars = document.querySelectorAll('#starRating span');
            stars.forEach((star, index) => {
                if (index < estrelasSelecionadas) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function enviarAvaliacao() {
            if (estrelasSelecionadas === 0) {
                alert('Por favor, selecione uma nota!');
                return;
            }

            const encontro = encontros.find(e => e.id === encontroAtualId);
            
            if (encontro.avaliacoes.some(a => a.usuario === usuarioAtual)) {
                alert('Você já avaliou este local!');
                return;
            }

            try {
                const novaAvaliacao = {
                    usuario: usuarioAtual,
                    nota: estrelasSelecionadas,
                    comentario: document.getElementById('comentario').value
                };

                const avaliacoesAtualizadas = [...encontro.avaliacoes, novaAvaliacao];

                await db.collection('encontros').doc(encontroAtualId).update({
                    avaliacoes: avaliacoesAtualizadas
                });

                fecharModal('modalAvaliar');
                alert('Avaliação enviada com sucesso!');
            } catch (error) {
                console.error('Erro ao enviar avaliação:', error);
                alert('Erro ao enviar avaliação');
            }
        }

        // ============================================
        // ADICIONAR/MARCAR ENCONTROS
        // ============================================
        async function adicionarNovoEncontro() {
            const nome = document.getElementById('novoNome').value.trim();
            const imagemInput = document.getElementById('novaImagemInput');

            if (!nome) {
                alert('Por favor, insira o nome do local!');
                return;
            }

            try {
                let imagem = null;
                if (imagemInput.files.length > 0) {
                    imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').add({
                    nome: nome,
                    imagem: imagem,
                    avaliacoes: [],
                    data: null,
                    isFuturo: false,
                    criadoEm: new Date()
                });

                fecharModal('modalNovoEncontro');
                document.getElementById('novoNome').value = '';
                imagemInput.value = '';
                document.getElementById('previewNovaImagem').innerHTML = '<div class="empty-state">Selecione uma imagem</div>';
                alert('Encontro adicionado com sucesso!');
            } catch (error) {
                console.error('Erro ao adicionar encontro:', error);
                alert('Erro ao adicionar encontro');
            }
        }

        async function marcarNovoEncontro() {
            const nome = document.getElementById('marcarNome').value.trim();
            const data = document.getElementById('marcarData').value;
            const imagemInput = document.getElementById('marcarImagemInput');

            if (!nome) {
                alert('Por favor, insira o nome do local!');
                return;
            }

            if (!data) {
                alert('Por favor, selecione uma data!');
                return;
            }

            try {
                let imagem = null;
                if (imagemInput.files.length > 0) {
                    imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').add({
                    nome: nome,
                    imagem: imagem,
                    avaliacoes: [],
                    data: data,
                    isFuturo: true,
                    criadoEm: new Date()
                });

                // Verificar achievement
                verificarAchievement();

                fecharModal('modalMarcarEncontro');
                document.getElementById('marcarNome').value = '';
                document.getElementById('marcarData').value = '';
                imagemInput.value = '';
                document.getElementById('previewMarcarImagem').innerHTML = '<div class="empty-state">Selecione uma imagem</div>';
                alert('Encontro agendado com sucesso!');
            } catch (error) {
                console.error('Erro ao marcar encontro:', error);
                alert('Erro ao marcar encontro');
            }
        }

        // ============================================
        // EDITAR ENCONTRO
        // ============================================
        async function salvarEdicaoEncontro() {
            const novoNome = document.getElementById('editarNomeInput').value.trim();
            const imagemInput = document.getElementById('editarImagemInput');
            const encontro = encontros.find(e => e.id === encontroEditando);

            if (!novoNome) {
                alert('Por favor, insira um nome válido!');
                return;
            }

            try {
                const atualizacoes = {
                    nome: novoNome
                };

                if (imagemInput.files.length > 0) {
                    atualizacoes.imagem = await lerArquivoComoBase64(imagemInput.files[0]);
                }

                await db.collection('encontros').doc(encontroEditando).update(atualizacoes);

                fecharModal('modalEditarEncontro');
                alert('Encontro atualizado com sucesso!');
            } catch (error) {
                console.error('Erro ao atualizar encontro:', error);
                alert('Erro ao atualizar encontro');
            }
        }

        // ============================================
        // EXCLUIR ENCONTRO (APENAS ADMIN)
        // ============================================
        async function excluirEncontro(id) {
            if (!isAdmin) {
                alert('Apenas administradores podem excluir encontros!');
                return;
            }

            if (confirm('Tem certeza que deseja excluir este encontro?')) {
                try {
                    await db.collection('encontros').doc(id).delete();
                    alert('Encontro excluído com sucesso!');
                } catch (error) {
                    console.error('Erro ao excluir encontro:', error);
                    alert('Erro ao excluir encontro');
                }
            }
        }

        // ============================================
        // ACHIEVEMENTS
        // ============================================
        function verificarAchievement() {
            const encontrosMarcados = encontros.filter(e => e.isFuturo && !dataPassou(e.data)).length;
            
            // Mostrar achievement apenas quando atingir múltiplos de 3
            if (encontrosMarcados % 3 === 0 && encontrosMarcados > 0) {
                const ciclo = encontrosMarcados / 3;
                mostrarAchievement(ciclo, encontrosMarcados);
            }
        }

        function mostrarAchievement(ciclo, totalEncontros) {
            let achievement;
            let mensagem;
            
            if (ciclo === 1) {
                achievement = { titulo: "Conversante", emoji: "💬" };
                mensagem = `Alguém marcou ${totalEncontros} encontros! Isso é mais que amizade!`;
            } else if (ciclo === 2) {
                achievement = { titulo: "Ficantes de Trabalho", emoji: "💼" };
                mensagem = `${totalEncontros} encontros marcados? Vocês não conseguem ficar um dia sem se ver!`;
            } else {
                achievement = { titulo: "Ficantes de Trabalho", emoji: "💼" };
                if (ciclo % 2 === 0) {
                    mensagem = `${totalEncontros} encontros marcados? Vocês não conseguem ficar um dia sem se ver!`;
                } else {
                    mensagem = `Alguém marcou ${totalEncontros} encontros! Isso é mais que amizade!`;
                }
            }
            
            document.getElementById('achievementIcon').textContent = achievement.emoji;
            document.getElementById('achievementTitle').textContent = `Parabéns, ${usuarioAtual}!`;
            document.getElementById('achievementSubtitle').textContent = `Agora vocês são: ${achievement.titulo}`;
            document.getElementById('achievementMessage').textContent = mensagem;
            
            document.getElementById('achievementModal').style.display = 'flex';
        }

        function fecharAchievement() {
            document.getElementById('achievementModal').style.display = 'none';
        }

        // ============================================
        // ADMIN - RESET
        // ============================================
        async function resetarEncontrosMarcados() {
            if (!isAdmin) {
                alert('Apenas administradores podem fazer isso!');
                return;
            }

            if (confirm('Deseja resetar apenas os encontros marcados?')) {
                try {
                    const batch = db.batch();
                    encontros.forEach(e => {
                        if (e.isFuturo) {
                            batch.update(db.collection('encontros').doc(e.id), {
                                isFuturo: false
                            });
                        }
                    });
                    await batch.commit();
                    alert('Encontros marcados resetados!');
                } catch (error) {
                    console.error('Erro ao resetar encontros marcados:', error);
                    alert('Erro ao resetar encontros marcados');
                }
            }
        }

        async function resetarTudo() {
            if (!isAdmin) {
                alert('Apenas administradores podem fazer isso!');
                return;
            }

            if (confirm('Tem certeza que deseja resetar TUDO? Essa ação não pode ser desfeita!')) {
                try {
                    // Deletar todos os encontros
                    const batch = db.batch();
                    encontros.forEach(e => {
                        batch.delete(db.collection('encontros').doc(e.id));
                    });
                    await batch.commit();

                    // Reinicializar com dados de exemplo
                    await inicializarDadosExemplo();
                    alert('Tudo foi resetado!');
                } catch (error) {
                    console.error('Erro ao resetar tudo:', error);
                    alert('Erro ao resetar tudo');
                }
            }
        }

        // ============================================
        // UTILITÁRIOS
        // ============================================
        function formatarData(dataString) {
            if (!dataString) return '';
            const data = new Date(dataString + 'T00:00:00');
            return data.toLocaleDateString('pt-BR');
        }

        function dataPassou(dataString) {
            if (!dataString) return false;
            const data = new Date(dataString + 'T00:00:00');
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            return data < hoje;
        }

        function previewImagem(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function lerArquivoComoBase64(arquivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(arquivo);
            });
        }

        window.onclick = function(event) {
            const modals = ['modalNovoEncontro', 'modalMarcarEncontro', 'modalAvaliar', 'modalEditarEncontro'];
            modals.forEach(id => {
                const modal = document.getElementById(id);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            const achievementModal = document.getElementById('achievementModal');
            if (event.target === achievementModal) {
                achievementModal.style.display = 'none';
            }
        }

        window.addEventListener('load', inicializar);
    </script>
</body>
</html>
